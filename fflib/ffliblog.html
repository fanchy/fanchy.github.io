<!DOCTYPE html>
<html lang="en">

<head>
    
    
    
    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    
    <title>FFLIB C++ 异步&amp;类型安全&amp;printf风格的日志库</title>
    
    
    












<!-- Place this data between the <head> tags of your website -->

<meta name="description" content="日志应该拥有良好的格式， 日志文件应该被良好的组织， 日志文件必须非常容易配置， 日志组件必须有高效的性能" />

  <meta name="keywords" itemprop="tags" content="fflib, c++, 日志, log"/>



  <meta name="keywords" itemprop="categories" content="fflib" />



<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image" />



<meta name="twitter:title" content="FFLIB C++ 异步&amp;类型安全&amp;printf风格的日志库" />
<meta name="twitter:description" content="日志应该拥有良好的格式， 日志文件应该被良好的组织， 日志文件必须非常容易配置， 日志组件必须有高效的性能" />


  <meta name="twitter:creator" content="@evanown" />


<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="https://h2cloud.org/thumbnail-jumbo.png" />
  <meta name="twitter:image" content="https://h2cloud.org/thumbnail-jumbo.png" />

<meta name="twitter:url" content="https://h2cloud.org//fflib/ffliblog.html" />

<!-- Open Graph data -->
<meta property="og:title" content="FFLIB C++ 异步&amp;类型安全&amp;printf风格的日志库" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://h2cloud.org//fflib/ffliblog.html" />


  <meta property="og:image" content="https://h2cloud.org/thumbnail-jumbo.png" />

<meta property="og:description" content="日志应该拥有良好的格式， 日志文件应该被良好的组织， 日志文件必须非常容易配置， 日志组件必须有高效的性能" />
<meta property="og:site_name" content="h2cloud" />


<meta property="og:locale" content="" />


  <meta property="article:published_time" content="2013-01-20T00:00:00+08:00" />




  
    <meta property="article:tag" content="fflib" />
  
    <meta property="article:tag" content="c++" />
  
    <meta property="article:tag" content="日志" />
  
    <meta property="article:tag" content="log" />
  





  
    <meta property="article:tag" content="fflib" />
  




    
    
    <link rel="canonical" href="https://h2cloud.org/fflib/ffliblog.html">
    
    
    
    <link rel="shortcut icon" href="https://h2cloud.org/favicon.ico">
    
    <meta name="robots" content="noarchive">
    
    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
        <link rel="alternate" media="handheld" href=""> -->
        
        
        <link rel="stylesheet" href="https://h2cloud.org/assets/css/style.css?v=">
    </head>
    <body>
        
        <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="https://h2cloud.org/">h2cloud</a>
    

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
                <a class="page-link" href="https://h2cloud.org/h2engine.html">H2engine</a>
              
            
          
            
            
              
                <a class="page-link" href="https://h2cloud.org/fflib.html">FFlib</a>
              
            
          
            
            
              
                <a class="page-link" href="https://h2cloud.org/fflua.html">FFlua</a>
              
            
          
            
            
              
                <a class="page-link" href="https://h2cloud.org/ffpython.html">FFpython</a>
              
            
          
            
            
              
                <a class="page-link" href="https://h2cloud.org/gamedev.html">Gamedev</a>
              
            
          
            
            
              
                <a class="page-link" href="https://h2cloud.org/ai.html">AI</a>
              
            
          
            
            
              
                <a class="page-link" href="https://h2cloud.org/tech.html">Tech</a>
              
            
          
            
            
              
                <a class="page-link" href="https://h2cloud.org/about.html">About</a>
              
            
          
        </div>
      </nav>
    
  </div>
</header>

        
        
        
        
        
        <section class="page-header">
            <h1 class="project-name">FFLIB C++ 异步&amp;类型安全&amp;printf风格的日志库</h1>
            <h2 class="project-tagline">定义log类来封装对于日志配置、格式化、输出的操作</h2>
            
            <!-- Post tagline -->
            
            <h2 class="project-date">
                <time datetime="2013-01-20T00:00:00+08:00" itemprop="datePublished">
                    
                    Jan 20, 2013
                </time>
                
                
                • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Evan Zhao</span></span>
                
            </h2>
            
            <!-- End: Post tagline -->
        </section>
        
        <section class="main-content">
            
            <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">FFLIB C++ 异步&amp;类型安全&amp;printf风格的日志库</h1>
    <p class="post-meta">
      <time datetime="2013-01-20T00:00:00+08:00" itemprop="datePublished">
        
        Jan 20, 2013
      </time>
      </p>
  </header> -->

  <div itemprop="articleBody">
    <h2 id="摘要">摘要</h2>
<p>C++程序的调试一般有调试器、printf、日志文件三种。Linux下的调试器为gdb，关于gdb的使用甚至可以单独用一本书来说明，
但是本章并不会过度讨论gdb，读者可以寻找相关的资料阅读。Gdb是C++程序调试中非常重要的调试手段，其有如下特点：</p>

<ul>
  <li>通过增加断点，可以观察重点代码的执行</li>
  <li>若程序出现segmentation fault，gdb可以输出调用堆栈，方便找到bug之所在</li>
  <li>有些逻辑代码段非常不容易触发，可以在gdb环境下通过加断点、修改内存来强制进入特定的代码段</li>
  <li>但是gdb不能用于生产环境，在几百上千在线的服务器程序上执行gdb的attach操作，是不可能接受的
   Gdb绝对是调试期的利器，另外一个调试期使用的既简单又实用的方法是printf，就是使用c库的函数printf输出变量到控制台。其优点是直观，可以完整的、清晰的观察程序的运行过程，而不需像gdb一样暂停程序。另外printf也只能用于开发调试环境，上线时服务器程序都是在后台运行的，printf将会失去作用。更重要的是因为gdb和printf都不会将数据存储，历史数据或历史操作都会在重启程序后消失。日志文件可以弥补gdb和printf的不足，我们需要一个具有如下功能的日志组件：</li>
  <li>用于调试可以显示、记录变量、数据，即能支持像printf一样可以实时的在控制台输出显示，又能将记录存储文件，方便搜索查看历史记录</li>
  <li>日志应该拥有良好的格式，即方便开发和运维人员的阅读，又要包含足够多的信息，例如事件记录时间、线程id、事件类型，事件的严重级别</li>
  <li>日志文件应该被良好的组织，一方面日志应该按照每天单独文件夹分类，另一方面日志日志文件并应该过大，否则使用编辑器打开、搜索将会非常困难。日志内容也应该组织分类，比如数据库的操作日志和用户做任务的日志应该有明确的标志，这样可以对日志文件进行grep等进行过滤分类查看。</li>
  <li>日志文件必须非常容易配置，当调试时期望看到尽可能多的内容，但是不关心的内容需要被过滤掉，比如调试用户任务模块时，可以不显示数据库相关日志。在上线后，运维只关心报错信息，比警告级别低的日志需要被屏蔽。在调试时，开发人员经常会盯着控制台的输出，相比于普通级别日志内容，错误级别的日志更应该引起开发注意力，所以重要级别的日志在控制台输出时应该有彩色高亮显示。</li>
  <li>日志组件必须有高效的性能，一方面调用者期望日志组件调用后立即返回不影响逻辑层的效率，另一方面写文件属于io操作，比起内存操作慢的多得多。所以要求日志的接口调用是异步的，日志组件单独开启线程执行写文件操作，只有如此才能尽最大程度满足程序的实时性。</li>
</ul>

<p>下面来探讨一下日志 的实现。</p>

<h4 id="实现类">实现类</h4>
<p>定义log_t类来封装对于日志配置、格式化、输出的操作。log_t主要的功能有：</p>

<ul>
  <li>支持对日志级别的配置</li>
  <li>支持对日志类别的配置</li>
  <li>支持配置日志内容是否输出到文件和控制台</li>
  <li>格式化日志
    <div class="language-cpp highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">log_t</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">log_t</span><span class="p">(</span><span class="kt">int</span> <span class="n">level_</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">all_class_</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">path_</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">file_</span><span class="p">,</span>
        <span class="kt">bool</span> <span class="n">print_file_</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">print_screen_</span><span class="p">);</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">log_t</span><span class="p">();</span>

  <span class="kt">void</span> <span class="n">mod_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">level_</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">flag_</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">mod_class</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">class_</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">flag_</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">mod_print_file</span><span class="p">(</span><span class="kt">bool</span> <span class="n">flag_</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">mod_print_screen</span><span class="p">(</span><span class="kt">bool</span> <span class="n">flag_</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">is_level_enabled</span><span class="p">(</span><span class="kt">int</span> <span class="n">level_</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">find_class_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">class_</span><span class="p">);</span>

  <span class="kt">void</span> <span class="n">log_content</span><span class="p">(</span><span class="kt">int</span> <span class="n">level_</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str_class_</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">content_</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>接口log_content 负责格式化和输出日志内容，其主要实现代码如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">log_t</span><span class="o">::</span><span class="n">log_content</span><span class="p">(</span><span class="kt">int</span> <span class="n">level_</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str_class_</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">content_</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">curtm</span><span class="p">;</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">curtm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">tm</span> <span class="n">tm_val</span> <span class="o">=</span> <span class="o">*</span><span class="n">localtime</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">curtm</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">));</span>

    <span class="kt">char</span> <span class="n">log_buff</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
    <span class="o">::</span><span class="n">snprintf</span><span class="p">(</span><span class="n">log_buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">log_buff</span><span class="p">),</span> <span class="s">"%02d:%02d:%02d.%03ld %s [%ld] [%s] "</span><span class="p">,</span>
            <span class="n">tm_val</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">tm_val</span><span class="p">.</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">tm_val</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">,</span> <span class="n">curtm</span><span class="p">.</span><span class="n">tv_usec</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">g_log_level_desp</span><span class="p">[</span><span class="n">level_</span><span class="p">],</span> <span class="n">gettid</span><span class="p">(),</span> <span class="n">str_class_</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">m_enable_file</span> <span class="o">&amp;&amp;</span> <span class="n">check_and_create_dir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm_val</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">m_file</span> <span class="o">&lt;&lt;</span> <span class="n">log_buff</span> <span class="o">&lt;&lt;</span> <span class="n">content_</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">m_file</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">m_enable_screen</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s%s%s%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">g_log_color_head</span><span class="p">[</span><span class="n">level_</span><span class="p">],</span> <span class="n">log_buff</span><span class="p">,</span> <span class="n">content_</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">g_log_color_tail</span><span class="p">[</span><span class="n">level_</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="其执行的主要过程如下">其执行的主要过程如下:</h4>

<ul>
  <li>格式化时间，包括调用时的时分秒以及毫秒，为什么没有年月日呢？日志目录已经安装每天一个文件夹分类了，故这里省略了年月日信息。</li>
  <li>增加日志级别信息，日志级别对应一个字符串描述，如debug级别日志每一行会包含DEBUG字符串。</li>
  <li>记录线程id，这里并没有直接使用::pthread_self() 获取线程id，而是获取线程在系统中分配的“TID”,要知道线程和进程在内核中都有唯一的id，可以通过top进行查看，top -H –p [pid] 可以查看进程内的所有线程的运行负载情况，如果某个线程运行负载很高，我们需要知道到底是那一部分逻辑是热点，通过搜索日志，可以知道该线程负责了哪块逻辑，从而能够发现问题。</li>
  <li>记录日志类别</li>
  <li>若配置允许输出屏幕，那么利用printf输出，不同的日志级别会有不同的显示颜色，如printf(“\033[1;33mDEBUG\033[0m”)， DEBUG 会以黄色输出。</li>
  <li>若配置允许输出文件，那么flush到文件中，若日期发生变化，重新创建日期目录，保证每一天一个文件夹，若单个文件内容超过5000行，会创建新的文件，避免文件内容过大，最终目录机构如下</li>
</ul>

<p><img src="/assets/img/ffliblog/ffliblog1.jpg" alt=""></p>

<h4 id="异步操作">异步操作</h4>
<p>为了保证日志接口尽可能的快，日志接口都是异步完成的其。时序图如下：</p>

<p><img src="/assets/img/ffliblog/ffliblog2.jpg" alt=""></p>

<p>对于用户层而言，调用日志组件接口的开销为日志内容格式化和拷贝字符串到队列，而相对开销较大的写文件、输出屏幕操作则有日志线程完成，这样可以最大程度的保证用户层的高效运行。</p>

<p>我们定义log_service_t封装异步操作，对于格式化和输出，log_service_t仍然通过log_t实现，log_service_t的职责有四：</p>

<ul>
  <li>封装异步接口，外部直接调用log_service_t的接口，一般log_service_t一单件模式使用</li>
  <li>Log_service_t接口模板函数，利用C++的泛型能力确保类型安全，比如当%s参数本应该是user.name()时，却手误写成user，log_service_t的接口保证在编译器就能报错。</li>
  <li>Log_service_t创建日志线程和日志任务队列，</li>
  <li>Log_service_t在初始化的时候接受配置日志组件的参数，同时它也支持在运行期修改参数，并且线程安全。</li>
</ul>

<h4 id="关键代码如下">关键代码如下：</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">log_service_t</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">log_service_t</span><span class="p">();</span>
    <span class="o">~</span><span class="n">log_service_t</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">opt_</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">stop</span><span class="p">();</span>

<span class="n">LOG_IMPL_MACRO</span><span class="p">(</span><span class="n">async_logdebug</span><span class="p">,</span> <span class="n">LOG_DEBUG</span><span class="p">);</span>
    <span class="n">LOG_IMPL_MACRO</span><span class="p">(</span><span class="n">async_logtrace</span><span class="p">,</span> <span class="n">LOG_TRACE</span><span class="p">);</span>
    <span class="n">LOG_IMPL_MACRO</span><span class="p">(</span><span class="n">async_loginfo</span><span class="p">,</span> <span class="n">LOG_INFO</span><span class="p">);</span>
    <span class="n">LOG_IMPL_MACRO</span><span class="p">(</span><span class="n">async_logwarn</span><span class="p">,</span> <span class="n">LOG_WARN</span><span class="p">);</span>
    <span class="n">LOG_IMPL_MACRO</span><span class="p">(</span><span class="n">async_logerror</span><span class="p">,</span> <span class="n">LOG_ERROR</span><span class="p">);</span>
    <span class="n">LOG_IMPL_MACRO</span><span class="p">(</span><span class="n">async_logfatal</span><span class="p">,</span> <span class="n">LOG_FATAL</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>
<p>由于各个日志级别的接口代码都是相似的，使用了LOG_IMPL_MACRO简化代码，LOG_IMPL_MACRO定义为：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define LOG_IMPL_NONE_ARG(func, LOG_LEVEL)      \
    inline void func(const char* class_, const char* fmt_)  \
    {     \
        if (m_log-&gt;is_level_enabled(LOG_LEVEL))  \
        {     \
            const char* class_name_str = m_log-&gt;find_class_name(class_); \
            if (class_name_str)     \
            { \
                m_task_queue.produce(task_binder_t::gen(&amp;log_t::log_content, m_log, LOG_LEVEL, \
                class_name_str, string(fmt_)));     \
            }  \
        }      \
    }
</span>
<span class="cp">#define LOG_IMPL_ARG1(func, LOG_LEVEL)      \
    template &lt;typename ARG1&gt;    \
    inline void func(const char* class_, const char* fmt_, const ARG1&amp; arg1_) \
    { \
        if (m_log-&gt;is_level_enabled(LOG_LEVEL)) \
        {     \
            const char* class_name_str = m_log-&gt;find_class_name(class_); \
            if (class_name_str)     \
            {  \
                str_format_t dest(fmt_);  \
                dest.append(arg1_);     \
                m_task_queue.produce(task_binder_t::gen(&amp;log_t::log_content, m_log, LOG_LEVEL, \
                 class_name_str, dest.gen_result()));     \
            } \
        } \
    }
</span>
<span class="cp">#define LOG_IMPL_MACRO(async_logdebug, LOG_DEBUG)     \
    LOG_IMPL_NONE_ARG(async_logdebug, LOG_DEBUG)      \
    LOG_IMPL_ARG1(async_logdebug, LOG_DEBUG)          \
    LOG_IMPL_ARG2(async_logdebug, LOG_DEBUG)          \
    LOG_IMPL_ARG3(async_logdebug, LOG_DEBUG)        \
    LOG_IMPL_ARG4(async_logdebug, LOG_DEBUG)        \
    LOG_IMPL_ARG5(async_logdebug, LOG_DEBUG)        \
    LOG_IMPL_ARG6(async_logdebug, LOG_DEBUG)
</span></code></pre></div></div>
<p>受篇幅所限，没有附上所有宏展开的代码，log_service_t初始化的代码如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">log_service_t</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">opt_</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_log</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"./log"</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">"log"</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">print_file</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">print_screen</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">arg_helper_t</span> <span class="n">arg</span><span class="p">(</span><span class="n">opt_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_level"</span><span class="p">).</span><span class="n">empty</span><span class="p">())</span> <span class="n">level</span> <span class="o">=</span> <span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_level"</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_path"</span><span class="p">).</span><span class="n">empty</span><span class="p">())</span> <span class="n">path</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_level"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_filename"</span><span class="p">).</span><span class="n">empty</span><span class="p">())</span> <span class="n">path</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_filename"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_print_file"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"false"</span> <span class="o">||</span> <span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_print_file"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"0"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">print_file</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_print_screen"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"true"</span> <span class="o">||</span> <span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_print_screen"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"1"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">print_screen</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">m_log</span> <span class="o">=</span> <span class="k">new</span> <span class="n">log_t</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">arg</span><span class="p">.</span><span class="n">get_option_value</span><span class="p">(</span><span class="s">"-log_class"</span><span class="p">),</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">print_file</span><span class="p">,</span> <span class="n">print_screen</span><span class="p">);</span>
    <span class="n">m_thread</span><span class="p">.</span><span class="n">create_thread</span><span class="p">(</span><span class="n">task_binder_t</span><span class="o">::</span><span class="n">gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_queue_t</span><span class="o">::</span><span class="n">run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_task_queue</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>代码很简单，也很直观，需要对读者解释的是，初始化接口start的参数为字符串，这样做的好处是可以从配置文件中读入日志配置参数后直接传给log_service_t的start接口，而用户层完全不需要关心日志配置语法的细节。Start函数创建log_t实例后，创建单独线程执行任务队列，而任务队列中的所有任务就是写日志内容或输出日志内容。</p>

<h5 id="格式化">格式化</h5>
<p>关于格式化输出，使用使用了模板函数和多态机制保证了绝对的类型安全，这也是相对于sprintf的巨大优越点。class str_format_t 是用来格式化字符串的工具类，它使用sprintf的格式化语法，但是额外提供了排错和纠错功能：</p>

<ul>
  <li>使用sprintf格式化语法，最基本的格式化参数都支持如%d,%u,%ld,%lu,%s,%c,%x,%p,%f甚至形如%04d设置字符串宽度的语法也是支持的</li>
  <li>str_format_t 类型安全，格式化参数支持整型、浮点数、字符串cost char*、指针、string,若赋值其他类型参数，则编译不能通过。</li>
  <li>str_format_t 拥有自动纠错功能，使用sprintf的时候除了类型不安全导致出错外，最常见的就是sprintf的格式化参数与赋值的参数个数不一致，如sprintf(buff, “%s,%s”, 100);这样的代码编译能够通过只有运行期才能发现出错，str_format_t 可以容忍这样的失误，当模板字符串中%比赋值的参数多时，str_format_t自动忽略多余的%，若%比后边的值参数少时，值参数自动追加到字符串尾部，这样最大程度的避免了出错和信息丢失。
关于基本类型的格式化模板函数：</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="nf">append</span><span class="p">(</span><span class="n">T</span> <span class="n">content_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">move_to_next_wildcard</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m_fmt_type</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="sc">'x'</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="s">"0x%x"</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">content_</span><span class="p">);</span>
                <span class="n">m_num_buff</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">m_strstream</span> <span class="o">&lt;&lt;</span> <span class="n">content_</span><span class="p">;</span>
                <span class="n">m_strstream</span> <span class="o">&gt;&gt;</span> <span class="n">m_num_buff</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">min_len</span> <span class="o">&gt;</span> <span class="n">m_num_buff</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">?</span> <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">min_len</span> <span class="o">-</span> <span class="n">m_num_buff</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(;</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span> <span class="n">width</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">m_result</span> <span class="o">+=</span> <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">fill_char</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">m_strstream</span> <span class="o">&lt;&lt;</span> <span class="n">content_</span><span class="p">;</span>
            <span class="n">m_strstream</span> <span class="o">&gt;&gt;</span> <span class="n">m_num_buff</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">m_result</span> <span class="o">+=</span> <span class="n">m_num_buff</span><span class="p">;</span>
        <span class="n">m_strstream</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="c1">//! clear error bit,not content</span>
        <span class="n">m_num_buff</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>关于字符串的特化函数：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">str_format_t</span><span class="o">::</span><span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">str_</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">move_to_next_wildcard</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">min_len</span> <span class="o">&gt;</span> <span class="n">str_</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">?</span> <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">min_len</span> <span class="o">-</span><span class="n">str_</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span> <span class="n">width</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">m_result</span> <span class="o">+=</span> <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">fill_char</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">m_result</span> <span class="o">+=</span> <span class="n">str_</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>move_to_next_wildcard 每次尝试移动到下一个%所在的位置，然后用值参数替换%的格式化。move_to_next_wildcard的整个开销是遍历字符串的开销：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">str_format_t</span><span class="o">::</span><span class="n">move_to_next_wildcard</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="kt">char</span> <span class="n">tmp</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="n">cur_format_index</span> <span class="o">&lt;</span> <span class="n">m_fmt_len</span><span class="p">;</span> <span class="o">++</span> <span class="n">cur_format_index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">m_fmt</span><span class="p">[</span><span class="n">cur_format_index</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="sc">'%'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">m_result</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">char</span> <span class="n">next</span> <span class="o">=</span> <span class="n">m_fmt</span><span class="p">[</span><span class="n">cur_format_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="sc">'%'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cur_format_index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">m_result</span> <span class="o">+=</span> <span class="n">next</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//! 支持多种格式化 %c %s, %d, %ld, %u, %lu, %x, %X, 找到格式化的类型</span>
        <span class="c1">//for (++cur_format_index; cur_format_index &lt; m_fmt_len; ++ cur_format_index)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">char</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">m_fmt</span><span class="p">[</span><span class="n">cur_format_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="sc">'\0'</span> <span class="o">||</span> <span class="n">cur</span> <span class="o">==</span> <span class="sc">'%'</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="sc">'c'</span> <span class="o">||</span> <span class="n">cur</span> <span class="o">==</span> <span class="sc">'d'</span> <span class="o">||</span> <span class="n">cur</span> <span class="o">==</span> <span class="sc">'u'</span> <span class="o">||</span> <span class="n">cur</span> <span class="o">==</span> <span class="sc">'x'</span> <span class="o">||</span>
                     <span class="n">cur</span> <span class="o">==</span> <span class="sc">'f'</span> <span class="o">||</span> <span class="n">cur</span> <span class="o">==</span> <span class="sc">'s'</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">type</span>    <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
                <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">min_len</span> <span class="o">=</span> <span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">m_fmt</span> <span class="o">+</span> <span class="n">cur_format_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">cur_format_index</span>   <span class="o">=</span> <span class="n">cur_format_index</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="sc">'0'</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">fill_char</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="sc">'l'</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">char</span> <span class="n">c_num</span> <span class="o">=</span> <span class="n">m_fmt</span><span class="p">[</span><span class="n">cur_format_index</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="sc">'d'</span> <span class="o">==</span> <span class="n">c_num</span> <span class="o">||</span> <span class="sc">'u'</span> <span class="o">==</span> <span class="n">c_num</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">type</span>    <span class="o">=</span> <span class="n">c_num</span><span class="p">;</span>
                    <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">min_len</span> <span class="o">=</span> <span class="o">::</span><span class="n">atoi</span><span class="p">(</span><span class="n">m_fmt</span> <span class="o">+</span> <span class="n">cur_format_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="n">cur_format_index</span>   <span class="o">=</span> <span class="n">cur_format_index</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="sc">'0'</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">m_fmt_type</span><span class="p">.</span><span class="n">fill_char</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">m_result</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="配置">配置</h3>
<p>最基本的log_service_t的start接口提供了初始化日志组件时的配置，配置参数:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">log_level_e</span>
<span class="p">{</span>
    <span class="n">LOG_FATAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">LOG_ERROR</span><span class="p">,</span>
    <span class="n">LOG_WARN</span><span class="p">,</span>
    <span class="n">LOG_INFO</span><span class="p">,</span>
    <span class="n">LOG_TRACE</span><span class="p">,</span>
    <span class="n">LOG_DEBUG</span><span class="p">,</span>
    <span class="n">LOG_LEVEL_NUM</span>
<span class="p">};</span>
</code></pre></div></div>
<ul>
  <li>-log_level 配置日志级别，0-5代表不同的日志级别，枚举定义如下：</li>
  <li>-log_path 配置日志文件存储的根目录</li>
  <li>-log_filename 配置文件名称</li>
  <li>-log_print_file” 配置日志是否输出到文件</li>
  <li>log_print_screen 配置日志是否输出到屏幕</li>
  <li>
    <ul>
      <li>log_class 配置哪些日志类别是开启的，只有 开启的类别日志才会被记录</li>
    </ul>
  </li>
</ul>

<p>这其中除了log_path和log_filename不需要运行期配置外，其他的配置都有运行期修改的需求，比如运行期某个类别的日志被关闭了，
但是为了跟踪某问题必须开启，如果不能动态修改日志配置往往会是开发人员面对问题时束手无策。</p>

<p>对于-log_print_file 和-log_print_screen 都是用bool记录的，-log_level 是整型记录的，都是直接支持运行期修改的。
有的读者可能指出日志不是有单独线程吗，而且使用线程组件的用户层也可能是多线程的，不就设计到了多线程竞争了吗？
在明白此答案之前，先让我们缕一缕log中的结构：</p>

<ul>
  <li>日志的接口会被多线程调用</li>
  <li>异步日志接口会访问日志的配置，判断该日志类别或级别是否已开启，由于只有读取操作，不需要加锁。</li>
  <li>日志格式化后投递到队列，队列是线程安全的，只有日志线程会从任务队列中消费任务。</li>
  <li>运行修改日志配置的操作会投递到日志线程完成，保证任一时刻只有一个线程修改日志配置</li>
</ul>

<p>对于-log_print_file 、-log_print_screen 和-log_level 都是多线程读取访问，某一时刻一个线程修改，并且三者都是基本类型的，
不存在内存地址变化的问题，这样日志线程修改后会立即生效。但是对于-log_class，</p>

<p>被开启的日志类别都被保存到set<string> 的结构中，多线程对其执行find操作是安全的，这个stl的多线程特性是明确支持的。
但是若对set<string> 在运行期执行insert或erase后会使set<string>中的迭代器失效，被坏的情况是会引起读操作的线程崩溃，</string></string></string></p>

<p>所以在运行期绝对不能对老的日志类别容器进行修改。难道日志类别就没办法运行期修改了吗？
脑筋急转弯一下，既然不能修改老的，为什么不创建一个新的，然后用新的替换老的？为了使用这个方法，需要一些小技巧：</p>

<ul>
  <li>使用一个指针引用当前日志级别的容器，度线程总是获取该指针，然后执行find操作find_class_name 根据类别字符串去容器中查找是否存在。
这里使用了原子操作ATOMIC_FETCH，在gcc的环境下可以把它定义为：</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define ATOMIC_FETCH(src_ptr)             __sync_add_and_fetch(src_ptr, 0)
</span><span class="k">typedef</span> <span class="n">set</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span>            <span class="n">str_set_t</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">str_set_t</span><span class="o">*&gt;</span>    <span class="n">ptr_vt_t</span><span class="p">;</span>
    <span class="n">str_set_t</span><span class="o">*</span>                    <span class="n">m_enable_class_set</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">log_t</span><span class="o">::</span><span class="n">find_class_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">class_</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">str_set_t</span><span class="o">*</span> <span class="n">pset</span> <span class="o">=</span> <span class="n">ATOMIC_FETCH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_enable_class_set</span><span class="p">);</span>
    <span class="n">str_set_t</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">pset</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">class_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">pset</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">).</span><span class="n">c_str</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>l find_class_name对于存储日志类别的容器指针使用了原子操作，所以要保证指针对应的数据永远不被修改，即使有新的配置产生时，
老的配置仍然不会被销毁，利用数据冗余保证无锁操作的线程安全，
最后将新配置容器的指针替换老配置的指针即可，同样使用原子操作完成</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define ATOMIC_SET(src_ptr, v)            (void)__sync_bool_compare_and_swap(src_ptr, *(src_ptr), v)
</span>

<span class="kt">void</span> <span class="n">log_t</span><span class="o">::</span><span class="n">mod_class</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">class_</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">flag_</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">str_set_t</span><span class="o">*</span> <span class="n">pset</span> <span class="o">=</span> <span class="k">new</span> <span class="n">str_set_t</span><span class="p">(</span><span class="n">m_enable_class_set</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">m_enable_class_set</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flag_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pset</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">class_</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">pset</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">class_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">m_class_set_history</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pset</span><span class="p">);</span>
    <span class="n">ATOMIC_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_enable_class_set</span><span class="p">,</span> <span class="n">pset</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="总结以上无锁编程的技巧有">总结以上无锁编程的技巧有：</h4>

<ul>
  <li>对于stl的对象的多线程读操作是安全的</li>
  <li>对于指针可以使用原子操作进行读取、更新、比较等操作</li>
  <li>老的容器被保存而不是销毁，从而保证了获取了老数据的线程仍然能够工作正常，日志的类别字符串只有十几顶多几十个，这里做数据冗余的内存开销是可以忽略的。</li>
</ul>

<h4 id="使用">使用</h4>
<p>日志的异步接口是由log_service_t定义的，前边介绍log_service_t的时候也提到了log_service_t一般是被单件使用的，如果每次调用singleton_t<log_service_t>::instance().async_logdebug(“XX”, “OhNice”);代码太长了，使用宏封装单件的操作：</log_service_t></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define LOG singleton_t&lt;log_service_t&gt;::instance()
#define LOGDEBUG(content)  singleton_t&lt;log_service_t&gt;::instance().async_logdebug content
#define LOGTRACE(content)  singleton_t&lt;log_service_t&gt;::instance().async_logtrace content
#define LOGINFO(content)   singleton_t&lt;log_service_t&gt;::instance().async_loginfo  content
#define LOGWARN(content)   singleton_t&lt;log_service_t&gt;::instance().async_logwarn  content
#define LOGERROR(content)  singleton_t&lt;log_service_t&gt;::instance().async_logerror content
#define LOGFATAL(content)  singleton_t&lt;log_service_t&gt;::instance().async_logfatal content
</span></code></pre></div></div>

<p>使用宏的好处是，比如logtrace可能会被到处使用了，而有可能其只在调试器有用，那么在release版本时候可以把宏LOGTRACE定义成空操作，
当然若日志级别不开启的情况下，调用LOGTRACE的开销是很小的，一般情况可以忽略其影响。</p>

<h5 id="使用示例">使用示例：</h5>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>

    <span class="n">LOG</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">"-log_path ./log -log_filename log -log_class FF,XX -log_print_screen true -log_print_file true -log_level 6"</span><span class="p">);</span>
    <span class="n">LOGDEBUG</span><span class="p">((</span><span class="s">"XX"</span><span class="p">,</span> <span class="s">"FFFFF"</span><span class="p">));</span>
    <span class="n">LOGTRACE</span><span class="p">((</span><span class="s">"XX"</span><span class="p">,</span> <span class="s">"FFFFF"</span><span class="p">));</span>
    <span class="n">LOGINFO</span><span class="p">((</span><span class="s">"XX"</span><span class="p">,</span> <span class="s">"FFFFF"</span><span class="p">));</span>
    <span class="n">LOGWARN</span><span class="p">((</span><span class="s">"XX"</span><span class="p">,</span> <span class="s">"FFFFF"</span><span class="p">));</span>
    <span class="n">LOGERROR</span><span class="p">((</span><span class="s">"XX"</span><span class="p">,</span> <span class="s">"FFFFF"</span><span class="p">));</span>
    <span class="n">LOGFATAL</span><span class="p">((</span><span class="s">"XX"</span><span class="p">,</span> <span class="s">"FFFFF"</span><span class="p">));</span>
    <span class="n">LOG</span><span class="p">.</span><span class="n">mod_class</span><span class="p">(</span><span class="s">"TT"</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">LOGFATAL</span><span class="p">((</span><span class="s">"TT"</span><span class="p">,</span> <span class="s">"FFFFF"</span><span class="p">));</span>

    <span class="n">LOGFATAL</span><span class="p">((</span><span class="s">"FF"</span><span class="p">,</span> <span class="s">"DSDFFFFF%s"</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">"SFWEGGGGGGGGG"</span><span class="p">)));</span>

    <span class="n">LOG</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="总结">总结：</h2>
<ul>
  <li>日志组件需要尽可能的快从而对于调用者的影响降到最低，使用异步接口可以使日志接口调用后立即返回</li>
  <li>日志的文件组织需要较好的被分类，目录首先按照时间分类，每天生成一个目录存储当天的日志，并且日志文件对大小做了上限，超过限制会重新创建新的文件，保证单个日志文件不会过大</li>
  <li>日志组件被设计成printf的格式化风格，但是增加了类型安全和参数纠错，不支持的类型会在编译期发现，值参数数目过多会被追加到字符串尾部，过少则忽略相应的%。</li>
  <li>日志组件是线程安全的，对于日志的配置虽然是多线程无锁访问的，仍然支持运行期动态的修改配置，其中使用了原子操作既保证了无锁编程的高效，又满足了多线程的稳定。
源码：https://github.com/fanchy/fflib</li>
</ul>

  </div>

  
</article>


<div id="comments"></div>


<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    new Valine({
        el: '#comments',
        app_id: '6jSO4XFbk0VGVYP8J0edX7gx-gzGzoHsz',   //这里变量的取值在网站配置文件里_config.yml
        app_key: 'mVHg9pxj49paNoLhs6AFADcy', //这里变量的取值在网站配置文件里_config.yml
        notify:false, 
        verify:false, 
        avatar:'mp', 
        placeholder:'分享你的观点'    //这里变量的取值在网站配置文件里_config.yml
    });
</script>





            
            <footer class="site-footer">
                <!-- SVG icons from https://iconmonstr.com -->
                
                <!-- Github icon -->
                <span class="my-span-icon">
                    <a href="https://github.com/fanchy" aria-label="fanchy's GitHub" title="fanchy's GitHub" target="_blank" rel="noopener noreferrer nofollow">
                        <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>
                    </a>
                </span>
                
                <!-- Twitter icon -->
                <span class="my-span-icon">
                    <a href="https://twitter.com/evanown" aria-label="fanchy's Twitter" title="fanchy's Twitter" target="_blank" rel="noopener noreferrer nofollow">
                        <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path></svg>
                    </a>
                </span>
                
                <!-- RSS icon -->
                
                
                <!-- Contact icon -->
                
                
                <span class="my-span-icon">
                    <a href="https://h2cloud.org/contact" aria-label="Contact" title="Contact fanchy">
                        <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"></path></svg>
                    </a>
                </span>
                
                <!-- <span class="my-span-icon" style="padding-bottom:5px;"> -->
                    <!-- <a href="https://h2cloud.org/contact" aria-label="Contact" title="Contact fanchy"> -->
                    <!-- 沪ICP备17021230号-1 -->
                    <!-- </a> -->
                <!-- </span> -->
            </footer>
        </section>
        
        <script>
            var menu = document.querySelector("nav.site-nav");
            var checkbox = document.getElementById("nav-trigger");
            
            // close menu if click outside menu
            document.addEventListener("click", function(e) {
                if (menu != e.target &&
                        !isDescendant(menu, e.target)) {
                    checkbox.checked = false;
                }
            }, false);
            
            function isDescendant(parent, child) {
                var node = child.parentNode;
                while (node != null) {
                    if (node == parent) {
                        return true;
                    }
                    node = node.parentNode;
                }
                return false;
            }  
        </script>
        
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0b0b03911bf3e050f9177fccd1e24775";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-124179560-1', 'auto');
  ga('send', 'pageview');
</script>
    </body>
    </html>
    