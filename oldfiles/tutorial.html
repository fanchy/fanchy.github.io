<!DOCTYPE html>

<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>服务器</title>

    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="author" content="">

    <!-- Bootstrap core CSS -->
     <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://cdn.bootcss.com/highlight.js/9.11.0/styles/xcode.min.css">

    <!-- Custom styles for this template -->
    <!-- <link rel="stylesheet" href="./index_files/style.css"> -->
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="http://cdn.bootcss.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
        .mkfont {
          font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
          font-size: 16px;
          line-height:25px;
          color: #333;
          background-color: #fff;
        }
    }
    </style>
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0b0b03911bf3e050f9177fccd1e24775";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>

<body>

    <nav class="navbar navbar-inverse navbar-fixed-top site-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">H2ENGINE</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    </li>
                    <li><a href="intro.html">Intro</a>
                    </li>
                    <li><a href="tutorial.html">TUTORIAL</a>
                    </li>
                    <li><a href="docs.html">DOCS</a>
                    </li>
                    <li><a href="download.html">DOWNLOAD</a>
                    </li>
                    <li><a href="faq.html">FAQ</a>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    
    <div class="container" style="margin-top:100px;">
        <div class="row">
            <textarea id="text-input" name="text-input" style="display:none;">
# H2Engine服务器氢引擎tutorial #
* * *

- [多协议：支 持WebSocket / Socket](./protocol.html)。
- [多语言支持：C++、python、lua、js、php，c++引擎加脚本处理逻辑，符合当下潮流](./scriptintro.html)。
- [数据库:集成了对Mysql和Sqlite的支持，提供同步异步以及连接池的封装](./databaseintro.html)。
- [分布式：基于ffrpc的分布式调用设计，异步rpc](./ffrpcintro.html)。
- [多进程数据共享：h2engine封装了非常方便的进程数据共享机制，解决例如行会、排名等全局数据难处理的特点](./sharedintro.html)。
- [非侵入是扩展：h2engine提供了非常方便的扩展机制，包括注册c++函数给脚本，增加新模块，增加client新消息处理函数等](./extintro.html)。
***

## 构建
H2Engine目前只有Linux版本，使用cmake，确保系统安装了cmake
> ```cpp
$ cmake  
```

H2Engine进程分另个，h2engine 和h2worker ,其中h2worker根据使用语言的不同，分h2workerpy、h2workerlua、h2workerjs、h2workerphp,根据你使用的语言构建你需要的h2worker即可。
> ```cpp
$make h2engine 
$make h2workerpy 
$make h2workerlua
$make h2workerjs
$make h2workerphp
```

## 依赖说明：
- cmake:构建的时候需要
- python2.6或python2.7:构建h2workerpy的时候需要
- lua5:构建h2workerlua的时候需要
- js v8:构建h2workerjs的时候需要
- libphp5:构建h2workerphp的时候需要,注意需要下载php源码编译出来允许嵌入的版本，./configure --enable-embed  --prefix=~/php5dir - --with-iconv=/usr/local/libiconv
## 运行

> ```cpp
$ ./h2engine -d
$ ./h2workerpy
$ ./h2workerlua
$ ./h2workerjs
$ ./h2workerphp
```

h2engine是核心，需要首先启动，woker进程根据你需要的语言，启动你需要的版本即可。


## 初始化与退出 ##
H2Engine把程序的框架都打好了，一般情况下，开发者不需要再修改main函数了，如果想在程序初始化的时候执行自己特有的一些
初始化操作，H2Engine提供一套非侵入式的初始化和退出的扩展接口。
    比如PlayerService是处理角色上线下线相关的协议消息的，需要再程序启动的时候，注册那些cmd协议需要交由此类处理，
那么再player_service.cpp中直接注册初始化函数，而不需要再去修改main.cpp中加入初始化代码.
> ```cpp
void PlayerService::handleLogin(userid_t sessionId, const std::string& data){
    logic code
}
#define LOGIN_CMD  1
static bool initEnvir(){
    FFWORKER_SINGLETON.regSessionReq(LOGIN_CMD, &PlayerService::handleLogin, &(PlayerServiceSingleton));
    return true;
}
WORKER_AT_SETUP(initEnvir);//!对应的WORKER_AT_EXIT(exitEnvir)处理退出时操作
```

* * *
## 注册脚本函数 ##
> ```cpp
static userid_t Entity_getUid(EntityPtr p){
    if (p){
        return p->getUid();
    }
    return 0;
}
static size_t Entity_totalNum(){
    return Entity::EntityPtr2Ref.size();
}
static bool initEntityEnvir(){
    //!这里演示的是如何注册脚本接口
    SCRIPT_UTIL.reg("Entity.getUid", Entity_getUid);
    SCRIPT_UTIL.reg("Entity.totalNum", Entity_totalNum);
    printf("initEntityEnvir....\n");
    return true;
}
WORKER_AT_SETUP(initEntityEnvir);
```

注册之后，无论你选择哪种脚本语言，都可以调用此函数，以Python为例，ffext.callFunc('Entity.totalNum')就可以调用Entity_totalNum这个
函数，H2Engine 的SCRIPT工具类对python，lua，js，php都做了适配，一次编写，人人可用。这个的初衷是，假如有人写了很好的c++封装类比如
成就系统，那么虽然你用的Python我用的lua，但是你的类库我也可以拿来即用。

* * *
## 事件机制 ##
> ```cpp
//db_service.cpp 处理对象增删改查相关的操作
static void handleCreateEntityEvent(CreateEntityEvent& e){
    printf("handleEvent %d %s\n", e.eventID(), e.eventName().c_str());
}
static void handleUpdateEntityEvent(UpdateEntityEvent& e){
    printf("handleUpdateEntityEvent %d %s\n", e.eventID(), e.eventName().c_str());
}
static void handleDelEntityEvent(DelEntityEvent& e){
    printf("handleDelEntityEvent %d %s\n", e.eventID(), e.eventName().c_str());
}
bool DbService::init(){
    EVENT_BUS_LISTEN(&handleCreateEntityEvent);
    EVENT_BUS_LISTEN(&handleUpdateEntityEvent);
    EVENT_BUS_LISTEN(&handleDelEntityEvent);
    return true;
}
static bool initEnvir(){
    return DbServiceSingleton.init();
}
WORKER_AT_SETUP(initEnvir);
```

H2Engine中封装了一个EventBus事件总线的机制，当产生事件的时候，丢到EventBus，监听此事件的函数会自动被调用，使用了观察者模式，
这样可以实现非侵入式的扩展功能，这也是H2Engine最大的设计特点。发布事件如下所示：
> ```cpp
handleCreateEntityEvent e(entity);
EVENT_BUS_FIRE(e);
```

* * *
## 定时器 ##
> ```cpp
void callback(arg1, arg2....)//!最多支持9个参数
{
}
int mstimeout_ = 1000;
FFWORKER_SINGLETON.regTimer(mstimeout_,  TaskBinder::gen(&lambda_cb::callback, arg1, arg2....));
```
            </textarea>
            <div id="markdown-preview" class="mkfont"> </div>
            
            
        </div>
    </div>

    ﻿<!-- Site footer
    
    <div id="footer" class="container" style="margin-top:50px">
        <nav class="navbar navbar-default navbar-fixed-bottom">
            <div class="navbar-inner navbar-content-center">
                <p class="text-muted credit" style="padding: 0px;">
                    <p class="text-center"><a href="http://www.miibeian.gov.cn/" target="_blank">沪ICP备17021230号-1</a></p>
                    
                </p>
            </div>
        </nav>
    </div>
  -->
    <div id="container">
        <div id="footer">
            <p class="text-muted credit text-center">
                <a  target="_blank">沪ICP备17021230号-1</a>
            </p>
        </div>
    </div>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->

    <script src="http://cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="http://cdn.bootcss.com/markdown.js/0.4.0/markdown.min.js"></script>
    <script src="http://cdn.bootcss.com/highlight.js/8.4/highlight.min.js"></script>
    <script>

      function Editor(input, preview) {
        this.update = function () {
            var strdata = input.value;
            if (strdata == "")
                strdata = " ";
            var a = strdata.substr(strdata.length-1, 1);
            while (a == '\n' || a == ' ' || a == '\r'){
                strdata = strdata.substr(0, strdata.length-1);
                if (strdata.length == 0)
                    break;
                a = strdata.substr(strdata.length-1, 1);
            }
            //alert(strdata+"a");
            var index = -1; //定义变量index控制索引值
            //当查找不到a，即indexOf()的值为-1时，结束循环
            var linenum = 0;
            do {
                index = strdata.indexOf("\n\n", index + 1); //使用第二个参数index+1，控制每一次查找都是从上一次查找到字符a的下一个索引位置开始
                if (index != -1) { //可以找到字符i
                    linenum += 1;
                }
            } while (index != -1);
            console.log('linenum:'+linenum);
            var genhtml = markdown.toHTML(strdata);
            
            genhtml = genhtml.replace(/<code>cpp/g, '<pre><code class="cpp">');
            genhtml = genhtml.replace(/<code>python/g, '<pre><code class="python">');
            genhtml = genhtml.replace(/<code>lua/g, '<pre><code class="lua">');
            genhtml = genhtml.replace(/<code>php/g, '<pre><code class="php">');
            genhtml = genhtml.replace(/<code>javascript/g, '<pre><code class="javascript">');
            genhtml = genhtml.replace(/code>/g, 'code></pre>');
            //
            if (linenum < 10){
                var needpx = (10 - linenum) * 80;
                genhtml += '<p style="margin-top:'+needpx+'px;"> </p>';
            }
            //alert(genhtml);
            
            preview.innerHTML = genhtml;
        };
        input.editor = this;
        this.update();
        
        //!highlight.min.js
        hljs.initHighlightingOnLoad();
        
      }
      var GetEByEd = function (id) { return document.getElementById(id); };

      new Editor(GetEByEd("text-input"), GetEByEd("markdown-preview"));
      
      //$(document).ready(function() {
      //    $('pre code').each(function(i, block) {
      //      hljs.highlightBlock(block);
      //    });
      //  });
    </script>
</body></html>

